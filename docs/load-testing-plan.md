# 부하 테스트 계획

## 1. 개요

### 1.1 목적
E-commerce API의 성능 한계점을 파악하고, 실제 운영 환경에서 발생할 수 있는 트래픽 급증 상황에 대비하여 시스템의 안정성과 처리 능력을 검증합니다.

### 1.2 테스트 도구
- **k6**: Grafana Labs에서 개발한 오픈소스 부하 테스트 도구. 코드 기반 테스트라 개발자에게 편리.
- Docker를 통한 격리된 테스트 환경 구성

### 1.3 테스트 환경

#### 애플리케이션 스택
- **API 서버**: Spring Boot 3.5.7 (Java 17) - `http://host.docker.internal:8080`
- (RAM : 4GB)

#### 인프라 스택 (Docker Compose)
- **MySQL 8.1**: 데이터베이스 (포트: 3306)
- **Redis 7.2**: 캐시 서버 (포트: 6379)
  - 인기 상품 조회 캐싱
  - 분산 락 (쿠폰 발급)
- **Kafka Cluster**: 메시지 큐 (3대 클러스터 - KRaft 모드)
  - kafka1 (포트: 19092)
  - kafka2 (포트: 29092)
  - kafka3 (포트: 39092)
  - 쿠폰 발급 비동기 처리용
  - Replication Factor: 3
- **Kafka UI**: Kafka 모니터링 대시보드 (포트: 8081)
- **json-server**: External Logging Mock Server (포트: 3000)
- (RAM : 8GB, container 간 공유)

#### 테스트 도구 스택
- **k6**: 부하 테스트 실행 엔진
- **InfluxDB 1.8**: k6 테스트 결과 저장 (포트: 8086)
- **Grafana**: 테스트 결과 시각화 대시보드 (포트: 3001)
  - 실시간 메트릭 모니터링
  - Endurance Test 필수 도구

### 1.4 기준 유저 수
- DAU 500

---

## 2. 부하 테스트 대상 API

### 2.1 우선순위 분류 기준
1. **비즈니스 임팩트**: 매출/수익과 직접 연관된 기능
2. **트래픽 예상량**: 높은 조회수가 예상되는 기능
3. **동시성 이슈**: 동시 요청 처리 시 문제가 발생할 수 있는 기능
4. **데이터 정합성**: 재고, 포인트 등 정확성이 중요한 기능

### 2.2 테스트 대상 API 목록

#### **현재 테스트 대상 (P0 - 높은 우선순위)**

| API | 엔드포인트 | 메서드 | 선정 이유 |
|-----|-----------|--------|----------|
| 인기 상품 조회 | `/api/products/popular` | GET | 이벤트/프로모션 시 트래픽 급증 예상, Redis 캐시 성능 검증 |
| 쿠폰 발급 (비동기) | `/api/coupons/issue/request` | POST | 비동기 처리 성능 검증, Kafka 메시지 큐 안정성, 이벤트 대응 |
| 주문 생성 | `/api/orders` | POST | 비즈니스 크리티컬, 재고 차감 동시성 이슈, 트랜잭션 정합성 |
| 결제 | `/api/orders/payment` | POST | 비즈니스 크리티컬, 포인트 차감 정합성, 장바구니 삭제 연동 |

> **테스트 범위 제한 이유**: P0 API는 비즈니스에 직접적인 영향을 미치며, 트래픽 급증 시 가장 먼저 문제가 발생할 가능성이 높은 핵심 기능입니다. 이들 API의 안정성과 성능을 먼저 검증한 후, 단계적으로 테스트 범위를 확대합니다.

#### **향후 테스트 예정 (P1, P2)**

<details>
<summary>중간 우선순위 (P1) - 클릭하여 펼치기</summary>

| API | 엔드포인트 | 메서드 | 선정 이유 |
|-----|-----------|--------|----------|
| 상품 목록 조회 | `/api/products` | GET | 메인 페이지, 높은 조회 빈도 |
| 상품 상세 조회 | `/api/products/{id}` | GET | 상품 확인 페이지, 높은 조회 빈도 |
| 상품 재고 조회 | `/api/products/{id}/stock` | GET | 실시간 재고 확인 필요 |
| 장바구니 조회 | `/api/cart` | GET | 구매 전 필수 확인 단계 |
| 장바구니 추가 | `/api/cart` | POST | 구매 의사 표현, 동시성 고려 |

</details>

<details>
<summary>낮은 우선순위 (P2) - 클릭하여 펼치기</summary>

| API | 엔드포인트 | 메서드 | 선정 이유 |
|-----|-----------|--------|----------|
| 상품 조회수 증가 | `/api/products/{id}/view` | PATCH | 통계 집계용, 정합성 덜 중요 |
| 주문 내역 조회 | `/api/orders/{id}` | GET | 주문 후 확인, 트래픽 적음 |
| 쿠폰 목록 조회 | `/api/coupons` | GET | 정적 데이터, 캐시 가능 |
| 장바구니 삭제 | `/api/cart/{id}` | DELETE | 트래픽 적음 |
| 쿠폰 발급 (동기) | `/api/coupons/issue` | POST | 비동기 방식으로 대체, 동기는 테스트 제외 |

</details>

---

## 3. 부하 테스트 시나리오

### 3.1 테스트 유형 정의

#### Load Test (부하 테스트)
- **목적**: 일반적인 운영 환경에서의 성능 확인
- **특징**: 일정한 사용자 수를 유지하며 지속적으로 부하 발생
- **기간**: 5-10분간 유지
- **적용 대상**: 주문 생성, 결제 처리

#### Peak Test (피크 테스트)
- **목적**: 갑작스런 트래픽 급증 상황 대응 능력 확인
- **특징**: 짧은 시간 내 급격한 사용자 증가/감소
- **기간**: 1-3분간 피크 유지
- **적용 대상**: 인기 상품 조회, 쿠폰 발급 (이벤트 시나리오)

#### Stress Test (스트레스 테스트)
- **목적**: 시스템의 한계점 파악 및 장애 발생 지점 확인
- **특징**: 점진적으로 부하를 증가시켜 시스템 한계 도달
- **기간**: 15-20분간 점진적 증가
- **적용 대상**: 전체 API 혼합 트래픽 (향후 계획)

#### Endurance Test (내구성 테스트)
- **목적**: 장시간 운영 시 메모리 누수, 리소스 고갈, 성능 저하 등의 문제 발견
- **특징**: 낮은~중간 수준의 일정한 부하를 장시간 유지
- **기간**: 1-24시간
- **적용 대상**: 인기 상품 조회, 쿠폰 발급 비동기 처리
- **검증 항목**:
  - 메모리 사용량 추이 (누수 여부)
  - DB 커넥션 풀 안정성
  - Redis 메모리 관리
  - 응답 시간 일관성 (시간 경과에 따른 성능 저하 여부)
  - Kafka Consumer Lag 누적 여부

### 3.2 시나리오별 상세 계획

> **현재 실행 대상**: P0 우선순위 API만 테스트합니다. 각 API당 1개의 핵심 시나리오를 적용하여 효율적으로 검증합니다.

#### 시나리오 1: 인기 상품 조회 - Peak Test
```
파일: k6/scripts/products-popular-list-peak.js (작성 완료)
대상: GET /api/products/popular
목표:
  - 피크 사용자: 1500명
  - 응답시간: p95 < 500ms, p99 < 1000ms
  - 에러율: < 5%
단계:
  - 2분: 0 → 300명 (평상시)
  - 30초: 300 → 1500명 (급증)
  - 2분: 1500명 유지 (이벤트 진행)
  - 1분: 1500 → 300명 (복구)
  - 2분: 300 → 0명 (종료)
특이사항:
  - 이벤트/프로모션 시작 시 트래픽 폭주 상황 시뮬레이션
  - Redis 캐시 효과 및 DB 부하 확인
```

#### 시나리오 2: 쿠폰 발급 비동기 처리 - Peak Test
```
파일: k6/scripts/coupons-issue-async-peak.js (작성 필요)
대상: POST /api/coupons/issue/request
목표:
  - 피크 사용자: 3000명
  - 응답시간: p95 < 500ms, p99 < 1000ms (접수만)
  - 에러율: < 5%
  - Kafka 메시지 처리 성공률: > 95%
단계:
  - 2분: 0 → 500명 (평상시)
  - 30초: 500 → 3000명 (급증)
  - 2분: 3000명 유지
  - 1분: 3000 → 500명 (복구)
  - 2분: 500 → 0명 (종료)
특이사항:
  - Kafka 메시지 큐 처리 성능 검증
  - 비동기 처리로 응답 시간 개선 확인
  - Consumer lag 모니터링
검증 항목:
  - 메시지 발행 성공률
  - Consumer 처리 지연 시간
  - 최종 발급 완료율
```

#### 시나리오 3: 주문 생성 - Load Test
```
파일: k6/scripts/orders-create-load.js (작성 필요)
대상: POST /api/orders
목표:
  - 동시 사용자: 300명
  - 응답시간: p95 < 1000ms, p99 < 2000ms
  - 에러율: < 5%
  - 재고 정합성: 100%
단계:
  - 2분: 0 → 300명 증가
  - 5분: 300명 유지
  - 2분: 300 → 0명 감소
특이사항:
  - 장바구니 → 주문 생성 플로우
  - 재고 차감 동시성 검증
  - 트랜잭션 처리 성능 확인
사전 준비:
  - 테스트용 사용자별 장바구니 데이터 준비
  - 충분한 상품 재고 준비
검증 항목:
  - 재고 차감 정합성 (초기 재고 - 주문 수량 = 최종 재고)
  - 재고 부족 시 주문 실패 정상 처리
```

#### 시나리오 4: 결제 처리 - Load Test
```
파일: k6/scripts/payment-load.js (작성 필요)
대상: POST /api/orders/payment
목표:
  - 동시 사용자: 200명
  - 응답시간: p95 < 1500ms, p99 < 3000ms
  - 에러율: < 1%
  - 포인트 정합성: 100%
단계:
  - 2분: 0 → 200명 증가
  - 5분: 200명 유지
  - 2분: 200 → 0명 감소
특이사항:
  - 포인트 차감 동시성 검증
  - 결제 실패 시 롤백 확인
  - 장바구니 삭제 정합성 확인
사전 준비:
  - 테스트용 사용자별 주문 데이터 준비
  - 충분한 포인트 충전
검증 항목:
  - 포인트 차감 정합성
  - 포인트 부족 시 결제 실패 정상 처리
  - 결제 완료 후 장바구니 상품 삭제 확인
```

---

### 3.3 선택적 Endurance Test (장시간 안정성 검증)

> **실행 조건**: Phase 1-2 테스트 통과 후, 장시간 운영 안정성이 중요한 경우에만 선택적으로 실행합니다.

<details>
<summary>Endurance Test 시나리오 - 클릭하여 펼치기</summary>

#### 인기 상품 조회 - Endurance Test (선택)
```
파일: k6/scripts/products-popular-endurance.js (작성 필요)
대상: GET /api/products/popular
목표:
  - 동시 사용자: 300명
  - 테스트 기간: 2시간
  - 응답시간: p95 < 500ms 유지
  - 에러율: < 0.5%
단계:
  - 5분: 0 → 300명
  - 115분: 300명 유지
  - 5분: 300 → 0명
검증 항목:
  - 메모리 누수 여부
  - Redis 캐시 안정성
  - 응답 시간 일관성 (초반 vs 후반 편차 < 10%)
```

#### 쿠폰 발급 비동기 - Endurance Test (선택)
```
파일: k6/scripts/coupons-issue-async-endurance.js (작성 필요)
대상: POST /api/coupons/issue/request
목표:
  - 동시 사용자: 500명
  - 테스트 기간: 4시간
  - Kafka Consumer Lag: < 1000 유지
  - 에러율: < 0.5%
단계:
  - 5분: 0 → 500명
  - 235분: 500명 유지
  - 5분: 500 → 0명
검증 항목:
  - Kafka Consumer Lag 누적 여부
  - 메시지 처리 성공률 100% 유지
  - DB 커넥션 누수 여부
  - 메모리 사용량 추이
```

</details>

---

### 3.4 향후 테스트 예정 시나리오

> **참고**: 아래 시나리오들은 P0 API 테스트 완료 후 단계적으로 진행할 예정입니다.

<details>
<summary>상품 조회 API (P1) - 클릭하여 펼치기</summary>

#### 상품 목록 조회 Load Test
```
파일: k6/scripts/products-list-load.js (작성 완료, 실행 대기)
대상: GET /api/products
목표: 동시 사용자 1000명, p95 < 500ms
```

#### 상품 상세 조회 Load Test
```
파일: k6/scripts/products-detail-load.js (작성 완료, 실행 대기)
대상: GET /api/products/{id}
목표: 동시 사용자 500명, p95 < 300ms
```

</details>

<details>
<summary>장바구니 API (P1) - 클릭하여 펼치기</summary>

#### 장바구니 추가 Load Test
```
파일: k6/scripts/cart-add-load.js (작성 필요)
대상: POST /api/cart
목표: 동시 사용자 500명, p95 < 300ms
```

</details>

<details>
<summary>통합 시나리오 - 클릭하여 펼치기</summary>

#### E2E 사용자 여정 시나리오
```
파일: k6/scripts/user-journey-scenario.js (작성 필요)
대상: 전체 구매 플로우 (목록 조회 → 장바구니 → 주문 → 결제)
목표: 동시 사용자 100명, 전체 플로우 완료율 > 90%
```

#### 혼합 트래픽 Stress Test
```
파일: k6/scripts/mixed-traffic-stress.js (작성 필요)
대상: 전체 API (조회:쓰기 = 7:3)
목표: 시스템 한계점 파악
```

</details>

---

## 4. 성능 목표 및 임계값 (Thresholds)

### 4.1 응답 시간 목표

| API 유형 | p50 | p95 | p99 | 목표 기준 |
|---------|-----|-----|-----|----------|
| 조회 API (목록) | < 200ms | < 500ms | < 1000ms | 사용자 체감 품질 |
| 조회 API (상세) | < 150ms | < 300ms | < 500ms | 빠른 응답 필수 |
| 쓰기 API (일반) | < 300ms | < 1000ms | < 2000ms | 비즈니스 로직 처리 |
| 쓰기 API (결제) | < 500ms | < 1500ms | < 3000ms | 정합성 우선 |
| 쓰기 API (쿠폰) | < 500ms | < 1000ms | < 3000ms | 락 처리 포함 |

### 4.2 에러율 목표

| 시나리오 | 목표 에러율 | 허용 조건 |
|---------|-----------|----------|
| Load Test | < 1% | 일반 운영 상황 |
| Peak Test | < 5% | 트래픽 급증 상황 |
| Stress Test | < 10% | 시스템 한계 테스트 |
| Endurance Test | < 0.5% | 장시간 안정성 테스트 (더 엄격한 기준) |

### 4.3 처리량 목표

| API | 목표 RPS | 근거 |
|-----|---------|------|
| 상품 목록 조회 | 500+ | 메인 페이지 트래픽 |
| 상품 상세 조회 | 300+ | 상세 페이지 트래픽 |
| 인기 상품 조회 | 200+ | 이벤트 페이지 |
| 장바구니 추가 | 100+ | 구매 의사 전환율 고려 |
| 주문 생성 | 50+ | 실제 구매 전환율 고려 |
| 결제 | 50+ | 주문과 동일 |
| 쿠폰 발급 | 200+ | 선착순 경쟁 |

### 4.4 리소스 사용률 목표

| 리소스 | 목표 사용률 | 알람 임계값 |
|--------|-----------|-----------|
| CPU | < 70% | > 80% |
| Memory | < 70% | > 85% |
| DB Connection Pool | < 70% | > 80% |
| Redis Connection | < 60% | > 75% |
| Disk I/O | < 60% | > 75% |

---

## 5. 테스트 실행 계획

### 5.1 실행 순서

> **핵심 시나리오**: 각 API당 1개씩, 총 4개의 필수 시나리오만 실행합니다. (약 40분 소요)

#### 필수 테스트 (Phase 1-2) - 총 약 40분

**Phase 1: 트래픽 급증 대응 (Peak Test)** - 약 20분
1. **인기 상품 조회 Peak Test** (시나리오 1)
   - 이벤트/프로모션 시 Redis 캐시 성능 검증
   - 소요 시간: 약 10분

2. **쿠폰 발급 비동기 Peak Test** (시나리오 2)
   - Kafka 메시지 큐 기반 비동기 처리 성능 검증
   - 소요 시간: 약 10분

**Phase 2: 비즈니스 크리티컬 (Load Test)** - 약 20분
3. **주문 생성 Load Test** (시나리오 3)
   - 재고 차감 동시성 제어 및 트랜잭션 정합성 확인
   - 소요 시간: 약 10분

4. **결제 처리 Load Test** (시나리오 4)
   - 포인트 차감 정합성 및 장바구니 연동 확인
   - 소요 시간: 약 10분

---

## 7. 성공 기준

### 7.1 기능적 성공 기준
- [ ] 모든 API가 정의된 응답 시간 임계값 충족
- [ ] 에러율이 목표치 이하 유지
- [ ] 재고/포인트/쿠폰 수량 정합성 100% 보장
- [ ] 동시성 제어 정상 동작 (중복 발급/차감 없음)

### 7.2 비기능적 성공 기준
- [ ] 피크 트래픽 후 시스템 정상 복구
- [ ] 리소스 사용률이 허용 범위 내 유지
- [ ] DB 커넥션 풀 고갈 없음
- [ ] 메모리 누수 없음

### 7.3 비즈니스 성공 기준
- [ ] 주문/결제 플로우 95% 이상 성공률
- [ ] 쿠폰 발급 비동기 처리 안정성 (Consumer Lag < 1000 유지)
- [ ] 이벤트 트래픽 급증 시 시스템 안정성 유지
- [ ] 사용자 이탈 최소화 (빠른 응답 시간)
- [ ] Endurance Test 시 성능 저하 없음 (초반 vs 후반 응답시간 편차 < 10%)

---

## 8. 위험 요소 및 대응 방안

### 8.1 예상 위험 요소

| 위험 요소 | 영향도 | 발생 가능성 | 대응 방안 |
|---------|-------|-----------|----------|
| DB 커넥션 풀 고갈 | 높음 | 중간 | 커넥션 풀 크기 조정, 타임아웃 설정 |
| Redis 메모리 부족 | 중간 | 낮음 | Eviction Policy 설정, 메모리 증설 |
| 재고 동시성 이슈 | 높음 | 높음 | 분산 락, 낙관적 락 적용 |
| 쿠폰 중복 발급 | 높음 | 중간 | 분산 락 + 유니크 제약 조건 |
| Kafka Consumer Lag | 중간 | 중간 | Consumer 수 증가, 배치 크기 조정 |
| OOM (Out of Memory) | 높음 | 낮음 | Heap 크기 조정, 메모리 프로파일링 |

### 8.2 테스트 중단 기준
- 에러율 50% 이상 지속 (1분 이상)
- 시스템 응답 없음 (Timeout 100% 발생)
- 데이터 정합성 오류 발견 (중복 발급, 마이너스 재고 등)
- 인프라 장애 (DB/Redis 다운)